# Текущие Проблемы с Системой Сегментации Стен

Этот документ суммирует основные проблемы, выявленные в процессе разработки и отладки системы сегментации стен для AR-приложения.

## 1. Блочность (Пикселизация) Маски Сегментации

Наиболее заметная визуальная проблема — это сильная блочность или пикселизация маски сегментации, которая отображается как на `RawImage` в UI, так и на AR-плоскостях.

**Возможные причины и направления для исследования:**

*   **Низкое разрешение выходного тензора модели:** ML-модель (segformer) выдает тензор с низким разрешением (например, 164x233, согласно логам). При апскейлинге до целевого разрешения (например, 640x480) без должной фильтрации возникает блочность.
    *   **Задача:** Исследовать, использует ли `SentisCompat.RenderTensorToTexture` или внутренние операции Sentis по умолчанию фильтрацию типа "ближайший сосед" (Point/Nearest-neighbor) при записи в `segmentationMaskTexture`. Если да, выяснить, можно ли принудительно установить билинейную или другую более качественную фильтрацию на этапе рендеринга тензора в текстуру.
*   **Фильтрация при чтении из `segmentationMaskTexture`:** Несмотря на установку `segmentationMaskTexture.filterMode = FilterMode.Bilinear;`, возможно, эта настройка не применяется корректно или переопределяется где-то еще.
    *   **Задача:** Убедиться, что `RawImage` и шейдер `Custom/ARWallPaint.shader` действительно используют билинейную фильтрацию при сэмплинге из `segmentationMaskTexture`. Проверить настройки материалов и код шейдера.
*   **Анализ отладочных текстур:** Сравнение `DebugMaskOutput_RawSentis.png` (сырой вывод модели, вероятно, апскейленный) и `DebugMaskOutput_PostCPU.png` (после CPU постобработки) должно показать, на каком этапе блочность становится наиболее выраженной.

## 2. Производительность и Задержки

Общее время обработки кадра составляет 250-300 мс, что приводит к низкой частоте обновления сегментации и задержкам в обнаружении и обновлении поверхностей. Это далеко от плавного real-time опыта.

**Возможные причины и направления для исследования:**

*   **Время выполнения ML-модели:** Основная часть времени, вероятно, уходит на выполнение самой модели нейронной сети.
    *   **Задача:** Профилировать отдельно этап выполнения модели (`worker.Execute(inputTensor)`) чтобы понять его вклад. Рассмотреть возможность использования менее "тяжелой" модели или квантованной версии, если доступно и качество приемлемо.
*   **Операции конвертации текстур и тензоров:** Преобразование `XRCpuImage` в `Texture2D`, затем в тензор, и обратно из тензора в `RenderTexture` занимает значительное время (десятки миллисекунд для каждой операции, согласно логам).
    *   **Задача:** Оптимизировать эти конвертации. Исследовать, есть ли более прямые или быстрые пути, возможно, с использованием `ComputeShader` для некоторых преобразований или более эффективных API Sentis/Unity.
*   **CPU Постобработка:** Даже если часть эффектов отключена (размытие, резкость), включенная постобработка (например, контраст) все еще выполняется на CPU и добавляет время.
    *   **Задача:** Перенести как можно больше операций постобработки на GPU (с использованием `ComputeShader` или кастомных шейдеров), если это еще не сделано полностью, или если текущая реализация GPU постобработки не оптимальна. Сейчас `enablePostProcessing = false`, но отдельные флаги, такие как `enableContrast = true`, могут все еще вызывать CPU-операции. Необходимо проверить логику в `RunInferenceAndPostProcess`.
*   **Пропуск кадров (`CAMERA_FRAME_SKIP_COUNT`):** Текущая логика пропускает кадры, чтобы снизить нагрузку, но это также снижает плавность.
    *   **Задача:** Оценить, является ли это оптимальным компромиссом, или улучшение производительности позволит обрабатывать больше кадров.

## 3. Качество и Стабильность Обнаружения Плоскостей

Пользователь выразил сомнение в том, что стандартный механизм обнаружения плоскостей ARFoundation подходит для задачи "покраски стен" в стиле Dulux Visualizer. Плоскости могут появляться не сразу, и их конфигурация может быть не идеальной для точного наложения сегментации.

**Возможные причины и направления для исследования:**

*   **Зависимость от качества AR-трекинга:** Стандартные плоскости ARFoundation зависят от того, насколько хорошо AR-система распознает реальные поверхности.
*   **Соответствие маски сегментации и геометрии AR-плоскостей:** Блочная маска, наложенная на гладкую AR-плоскость, все равно будет выглядеть грубо.
    *   **Задача:** Определить, является ли основной проблемой геометрия плоскостей или качество самой маски.
*   **Необходимость кастомной геометрии:** Для более точного и "обволакивающего" эффекта, как в продвинутых визуализаторах, может потребоваться создание кастомных 3D-мешей на основе контуров сегментированных областей, а не использование стандартных AR-плоскостей.
    *   **Задача:** Исследовать алгоритмы извлечения контуров из маски сегментации и генерации мешей в реальном времени. Оценить сложность и производительность такого подхода.

## 4. Имитация Функционала "Dulux Visualizer"

Общая цель — достичь пользовательского опыта, сравнимого с Dulux Visualizer, что подразумевает:
*   Плавную и быструю сегментацию стен.
*   Точное и аккуратное "окрашивание" без явных артефактов (блочности, задержек).
*   Интуитивное взаимодействие.

**Направления для исследования:**
*   **Анализ Dulux Visualizer:** Если возможно, изучить (например, по видео демонстрациям, обзорам) как он работает, какие технологии может использовать.
*   **Комплексный подход:** Решение, вероятно, потребует комбинации улучшений в производительности модели, качестве апскейлинга маски, возможно, кастомной генерации геометрии и умной постобработки/сглаживания.

---

Этот список будет служить основой для дальнейших исследований и разработок. 